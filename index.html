<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Caf√© La Caba√±a - Men√∫</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#92400e">
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="module">
      import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
      import { getFirestore, collection, addDoc, serverTimestamp, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
      import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, GoogleAuthProvider, signInWithPopup } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

      const firebaseConfig = {
        apiKey: "AIzaSyAcnpjZmvIX1qdHkj4j0TTg13tOVYbZpn0",
        authDomain: "cafe-la-cabana-30fa5.firebaseapp.com",
        projectId: "cafe-la-cabana-30fa5",
        storageBucket: "cafe-la-cabana-30fa5.firebasestorage.app",
        messagingSenderId: "1013891358492",
        appId: "1:1013891358492:web:a80b4dff4aafe1375ea4d9"
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);
      const googleProvider = new GoogleAuthProvider();
      
      window.firebaseDB = db;
      window.firebaseAuth = auth;
      window.googleProvider = googleProvider;
      window.firestoreCollection = collection;
      window.firestoreAddDoc = addDoc;
      window.firestoreServerTimestamp = serverTimestamp;
      window.firestoreOnSnapshot = onSnapshot;
      window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
      window.signInWithEmailAndPassword = signInWithEmailAndPassword;
      window.signOut = signOut;
      window.onAuthStateChanged = onAuthStateChanged;
      window.signInWithPopup = signInWithPopup;
      window.firebaseReady = true;
      
      console.log('‚úÖ Firebase inicializado correctamente');
    </script>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script type="text/babel">
        const CafeLaCabana = () => {
          const [user, setUser] = React.useState(null);
          const [loading, setLoading] = React.useState(true);
          const [showAuthModal, setShowAuthModal] = React.useState(false);
          const [authMode, setAuthMode] = React.useState('login');
          const [authData, setAuthData] = React.useState({ email: '', password: '', name: '', phone: '' });
          const [authError, setAuthError] = React.useState('');
          const [isAuthenticating, setIsAuthenticating] = React.useState(false);
          const [menuItems, setMenuItems] = React.useState([]);
          const [loadingProducts, setLoadingProducts] = React.useState(true);
          const [cart, setCart] = React.useState([]);
          const [showCart, setShowCart] = React.useState(false);
          const [selectedCategory, setSelectedCategory] = React.useState('all');
          const [showOrderModal, setShowOrderModal] = React.useState(false);
          const [orderNotes, setOrderNotes] = React.useState('');
          const [isSubmitting, setIsSubmitting] = React.useState(false);

          const categories = [
            { id: 'all', name: 'Todo' },
            { id: 'hot', name: 'Calientes' },
            { id: 'cold', name: 'Fr√≠as' },
            { id: 'dessert', name: 'Postres' },
            { id: 'snack', name: 'Snacks' }
          ];

          React.useEffect(() => {
            const waitForFirebase = setInterval(() => {
              if (window.firebaseReady) {
                clearInterval(waitForFirebase);
                loadProducts();
              }
            }, 100);
            return () => clearInterval(waitForFirebase);
          }, []);

          const loadProducts = () => {
            try {
              const productsRef = window.firestoreCollection(window.firebaseDB, 'products');
              const unsubscribe = window.firestoreOnSnapshot(productsRef, 
                (snapshot) => {
                  const productsData = [];
                  snapshot.forEach((doc) => { productsData.push({ id: doc.id, ...doc.data() }); });
                  setMenuItems(productsData);
                  setLoadingProducts(false);
                },
                (error) => { 
                  console.error('‚ùå Error cargando productos:', error); 
                  setLoadingProducts(false); 
                }
              );
              return () => unsubscribe();
            } catch (error) {
              console.error('‚ùå Error en loadProducts:', error);
              setLoadingProducts(false);
            }
          };

          React.useEffect(() => {
            const waitForAuth = setInterval(() => {
              if (window.firebaseReady) {
                clearInterval(waitForAuth);
                window.onAuthStateChanged(window.firebaseAuth, (user) => {
                  if (user) {
                    console.log('‚úÖ Usuario autenticado:', user.email);
                    setUser({ uid: user.uid, email: user.email, name: user.displayName || 'Cliente', phone: '' });
                  } else {
                    console.log('‚ö†Ô∏è No hay usuario autenticado');
                    setUser(null);
                    setShowAuthModal(true);
                  }
                  setLoading(false);
                });
              }
            }, 100);
            return () => clearInterval(waitForAuth);
          }, []);

          const handleRegister = async (e) => {
            e.preventDefault();
            setAuthError('');
            setIsAuthenticating(true);
            try {
              if (!authData.name.trim()) throw new Error('Por favor ingresa tu nombre');
              if (!authData.phone.trim()) throw new Error('Por favor ingresa tu tel√©fono');
              const userCredential = await window.createUserWithEmailAndPassword(window.firebaseAuth, authData.email, authData.password);
              await window.firestoreAddDoc(window.firestoreCollection(window.firebaseDB, 'users'), {
                uid: userCredential.user.uid,
                name: authData.name,
                email: authData.email,
                phone: authData.phone,
                createdAt: window.firestoreServerTimestamp()
              });
              setUser({ uid: userCredential.user.uid, email: authData.email, name: authData.name, phone: authData.phone });
              setShowAuthModal(false);
              setAuthData({ email: '', password: '', name: '', phone: '' });
            } catch (error) {
              console.error('‚ùå Error en registro:', error);
              if (error.code === 'auth/email-already-in-use') setAuthError('Este email ya est√° registrado');
              else if (error.code === 'auth/weak-password') setAuthError('La contrase√±a debe tener al menos 6 caracteres');
              else if (error.code === 'auth/invalid-email') setAuthError('Email inv√°lido');
              else setAuthError(error.message);
            } finally {
              setIsAuthenticating(false);
            }
          };

          const handleLogin = async (e) => {
            e.preventDefault();
            setAuthError('');
            setIsAuthenticating(true);
            try {
              await window.signInWithEmailAndPassword(window.firebaseAuth, authData.email, authData.password);
              setShowAuthModal(false);
              setAuthData({ email: '', password: '', name: '', phone: '' });
            } catch (error) {
              console.error('‚ùå Error en login:', error);
              if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                setAuthError('Email o contrase√±a incorrectos');
              } else {
                setAuthError('Error al iniciar sesi√≥n');
              }
            } finally {
              setIsAuthenticating(false);
            }
          };

          const handleGoogleLogin = async () => {
            setAuthError('');
            setIsAuthenticating(true);
            try {
              const result = await window.signInWithPopup(window.firebaseAuth, window.googleProvider);
              await window.firestoreAddDoc(window.firestoreCollection(window.firebaseDB, 'users'), {
                uid: result.user.uid,
                name: result.user.displayName || 'Cliente',
                email: result.user.email,
                phone: '',
                createdAt: window.firestoreServerTimestamp()
              });
              setShowAuthModal(false);
            } catch (error) {
              console.error('‚ùå Error en Google login:', error);
              if (error.code === 'auth/popup-closed-by-user') setAuthError('Inicio de sesi√≥n cancelado');
              else setAuthError('Error al iniciar sesi√≥n con Google');
            } finally {
              setIsAuthenticating(false);
            }
          };

          const handleLogout = async () => {
            if (confirm('¬øCerrar sesi√≥n?')) {
              try {
                await window.signOut(window.firebaseAuth);
                setCart([]);
              } catch (error) {
                console.error('‚ùå Error en logout:', error);
              }
            }
          };

          const addToCart = (item) => {
            const existingItem = cart.find(i => i.id === item.id);
            if (existingItem) {
              setCart(cart.map(i => i.id === item.id ? { ...i, quantity: i.quantity + 1 } : i));
            } else {
              setCart([...cart, { ...item, quantity: 1 }]);
            }
          };

          const removeFromCart = (itemId) => {
            const existingItem = cart.find(i => i.id === itemId);
            if (existingItem.quantity === 1) {
              setCart(cart.filter(i => i.id !== itemId));
            } else {
              setCart(cart.map(i => i.id === itemId ? { ...i, quantity: i.quantity - 1 } : i));
            }
          };

          const deleteFromCart = (itemId) => { setCart(cart.filter(i => i.id !== itemId)); };

          const getTotal = () => { return cart.reduce((sum, item) => sum + (item.price * item.quantity), 0); };

          const openOrderModal = () => {
            if (cart.length === 0) {
              alert('Tu carrito est√° vac√≠o');
              return;
            }
            setShowOrderModal(true);
          };

          const submitOrder = async (e) => {
            e.preventDefault();
            setIsSubmitting(true);
            
            try {
              if (!user) throw new Error('No hay usuario autenticado');
              
              const order = {
                userId: user.uid,
                customerName: user.name,
                customerEmail: user.email,
                customerPhone: user.phone || 'No proporcionado',
                items: cart.map(item => ({
                  id: item.id,
                  name: item.name,
                  price: item.price,
                  quantity: item.quantity,
                  image: item.image
                })),
                total: getTotal(),
                notes: orderNotes,
                status: 'pending',
                createdAt: window.firestoreServerTimestamp()
              };
              
              const ordersRef = window.firestoreCollection(window.firebaseDB, 'orders');
              const docRef = await window.firestoreAddDoc(ordersRef, order);
              
              setCart([]);
              setOrderNotes('');
              setShowOrderModal(false);
              setShowCart(false);
              
              alert('Pedido realizado con √©xito. ID: ' + docRef.id);
              
            } catch (error) {
              alert('Error al enviar pedido: ' + error.message);
            } finally {
              setIsSubmitting(false);
            }
          };

          const filteredItems = selectedCategory === 'all' ? menuItems : menuItems.filter(item => item.category === selectedCategory);

          if (loading) {
            return (
              <div className="min-h-screen bg-gradient-to-br from-amber-50 to-orange-50 flex items-center justify-center">
                <div className="text-center">
                  <div className="text-6xl mb-4 animate-bounce">‚òï</div>
                  <p className="text-xl text-gray-600">Cargando...</p>
                </div>
              </div>
            );
          }

          return (
            <div className="min-h-screen bg-gradient-to-br from-amber-50 to-orange-50">
              <header className="bg-gradient-to-r from-amber-800 to-orange-700 text-white shadow-lg sticky top-0 z-40">
                <div className="container mx-auto px-4 py-4">
                  <div className="flex justify-between items-center">
                    <div>
                      <h1 className="text-2xl md:text-3xl font-bold flex items-center gap-2">‚òï Caf√© La Caba√±a</h1>
                      <p className="text-amber-100 text-sm mt-1">Sabor que inspira tu d√≠a</p>
                      {user && <p className="text-amber-200 text-xs mt-1">üë§ Hola, {user.name}!</p>}
                    </div>
                    <div className="flex gap-2 items-center">
                      <button onClick={() => setShowCart(!showCart)} className="relative bg-white text-amber-800 px-3 md:px-4 py-2 rounded-full font-semibold hover:bg-amber-100 transition flex items-center gap-2">
                        üõí <span className="hidden md:inline">{cart.length}</span>
                        {cart.length > 0 && (
                          <span className="absolute -top-2 -right-2 bg-red-500 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs">
                            {cart.reduce((sum, item) => sum + item.quantity, 0)}
                          </span>
                        )}
                      </button>
                      <button onClick={handleLogout} className="bg-red-500 text-white px-2 md:px-3 py-2 rounded-lg text-sm hover:bg-red-600 transition">üö™</button>
                    </div>
                  </div>
                </div>
              </header>

              <div className="bg-white shadow-md sticky top-16 md:top-20 z-30">
                <div className="container mx-auto px-4 py-4">
                  <div className="flex gap-2 overflow-x-auto">
                    {categories.map(cat => (
                      <button key={cat.id} onClick={() => setSelectedCategory(cat.id)}
                        className={`px-4 py-2 rounded-full font-medium whitespace-nowrap transition ${
                          selectedCategory === cat.id ? 'bg-amber-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                        }`}>
                        {cat.name}
                      </button>
                    ))}
                  </div>
                </div>
              </div>

              <div className="container mx-auto px-4 py-8">
                {loadingProducts ? (
                  <div className="text-center py-12">
                    <div className="text-6xl mb-4 animate-bounce">‚è≥</div>
                    <p className="text-xl text-gray-600">Cargando productos...</p>
                  </div>
                ) : menuItems.length === 0 ? (
                  <div className="text-center py-12 bg-white rounded-lg shadow">
                    <div className="text-6xl mb-4">üì¶</div>
                    <p className="text-xl text-gray-600 mb-4">No hay productos disponibles</p>
                    <p className="text-gray-500">Los productos aparecer√°n cuando se agreguen desde el admin</p>
                  </div>
                ) : filteredItems.length === 0 ? (
                  <div className="text-center py-12 bg-white rounded-lg shadow">
                    <div className="text-6xl mb-4">üîç</div>
                    <p className="text-xl text-gray-600">No hay productos en esta categor√≠a</p>
                  </div>
                ) : (
                  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    {filteredItems.map(item => (
                      <div key={item.id} className="bg-white rounded-xl shadow-md overflow-hidden hover:shadow-xl transition transform hover:-translate-y-1">
                        <div className="h-48 overflow-hidden">
                          <img src={item.image} alt={item.name} className="w-full h-full object-cover"/>
                        </div>
                        <div className="p-5">
                          <h3 className="text-xl font-bold text-gray-800 mb-2">{item.name}</h3>
                          <p className="text-gray-600 text-sm mb-4">{item.description}</p>
                          <div className="flex justify-between items-center">
                            <p className="text-lg font-bold text-amber-700">${item.price}</p>
                            <button onClick={() => addToCart(item)}
                              className="bg-amber-600 text-white px-4 py-2 rounded-lg hover:bg-amber-700 transition">
                              Agregar
                            </button>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </div>

            </div>
          );
        };

        ReactDOM.render(<CafeLaCabana />, document.getElementById("root"));
    </script>
</body>
</html>
