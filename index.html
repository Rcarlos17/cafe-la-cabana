<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Caf√© La Caba√±a - Men√∫</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#92400e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="module">
      import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
      import { getFirestore, collection, addDoc, serverTimestamp, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
      import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, GoogleAuthProvider, signInWithPopup } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

      const firebaseConfig = {
        apiKey: "AIzaSyAcnpjZmvIX1qdHkj4j0TTg13tOVYbZpn0",
        authDomain: "cafe-la-cabana-30fa5.firebaseapp.com",
        projectId: "cafe-la-cabana-30fa5",
        storageBucket: "cafe-la-cabana-30fa5.firebasestorage.app",
        messagingSenderId: "1013891358492",
        appId: "1:1013891358492:web:a80b4dff4aafe1375ea4d9"
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);
      const googleProvider = new GoogleAuthProvider();
      
      window.firebaseDB = db;
      window.firebaseAuth = auth;
      window.googleProvider = googleProvider;
      window.firestoreCollection = collection;
      window.firestoreAddDoc = addDoc;
      window.firestoreServerTimestamp = serverTimestamp;
      window.firestoreOnSnapshot = onSnapshot;
      window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
      window.signInWithEmailAndPassword = signInWithEmailAndPassword;
      window.signOut = signOut;
      window.onAuthStateChanged = onAuthStateChanged;
      window.signInWithPopup = signInWithPopup;
      window.firebaseReady = true;
    </script>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script type="text/babel">
        const CafeLaCabana = () => {
          const [user, setUser] = React.useState(null);
          const [loading, setLoading] = React.useState(true);
          const [showAuthModal, setShowAuthModal] = React.useState(false);
          const [authMode, setAuthMode] = React.useState('login');
          const [authData, setAuthData] = React.useState({ email: '', password: '', name: '', phone: '' });
          const [authError, setAuthError] = React.useState('');
          const [isAuthenticating, setIsAuthenticating] = React.useState(false);
          const [menuItems, setMenuItems] = React.useState([]);
          const [loadingProducts, setLoadingProducts] = React.useState(true);
          const [cart, setCart] = React.useState([]);
          const [showCart, setShowCart] = React.useState(false);
          const [selectedCategory, setSelectedCategory] = React.useState('all');
          const [showOrderModal, setShowOrderModal] = React.useState(false);
          const [orderNotes, setOrderNotes] = React.useState('');
          const [isSubmitting, setIsSubmitting] = React.useState(false);

          const categories = [
            { id: 'all', name: 'Todo' },
            { id: 'hot', name: 'Calientes' },
            { id: 'cold', name: 'Fr√≠as' },
            { id: 'dessert', name: 'Postres' },
            { id: 'snack', name: 'Snacks' }
          ];

          React.useEffect(() => {
            const waitForFirebase = setInterval(() => {
              if (window.firebaseReady) {
                clearInterval(waitForFirebase);
                loadProducts();
              }
            }, 100);
            return () => clearInterval(waitForFirebase);
          }, []);

          const loadProducts = () => {
            try {
              const productsRef = window.firestoreCollection(window.firebaseDB, 'products');
              const unsubscribe = window.firestoreOnSnapshot(productsRef, 
                (snapshot) => {
                  const productsData = [];
                  snapshot.forEach((doc) => { productsData.push({ id: doc.id, ...doc.data() }); });
                  setMenuItems(productsData);
                  setLoadingProducts(false);
                },
                (error) => { console.error('Error:', error); setLoadingProducts(false); }
              );
              return () => unsubscribe();
            } catch (error) {
              console.error('Error:', error);
              setLoadingProducts(false);
            }
          };

          React.useEffect(() => {
            const waitForAuth = setInterval(() => {
              if (window.firebaseReady) {
                clearInterval(waitForAuth);
                window.onAuthStateChanged(window.firebaseAuth, (user) => {
                  if (user) {
                    setUser({ uid: user.uid, email: user.email, name: user.displayName || 'Cliente', phone: '' });
                  } else {
                    setUser(null);
                    setShowAuthModal(true);
                  }
                  setLoading(false);
                });
              }
            }, 100);
            return () => clearInterval(waitForAuth);
          }, []);

          const handleRegister = async (e) => {
            e.preventDefault();
            setAuthError('');
            setIsAuthenticating(true);
            try {
              if (!authData.name.trim()) throw new Error('Por favor ingresa tu nombre');
              if (!authData.phone.trim()) throw new Error('Por favor ingresa tu tel√©fono');
              const userCredential = await window.createUserWithEmailAndPassword(window.firebaseAuth, authData.email, authData.password);
              await window.firestoreAddDoc(window.firestoreCollection(window.firebaseDB, 'users'), {
                uid: userCredential.user.uid,
                name: authData.name,
                email: authData.email,
                phone: authData.phone,
                createdAt: window.firestoreServerTimestamp()
              });
              setUser({ uid: userCredential.user.uid, email: authData.email, name: authData.name, phone: authData.phone });
              setShowAuthModal(false);
              setAuthData({ email: '', password: '', name: '', phone: '' });
            } catch (error) {
              if (error.code === 'auth/email-already-in-use') setAuthError('Este email ya est√° registrado');
              else if (error.code === 'auth/weak-password') setAuthError('La contrase√±a debe tener al menos 6 caracteres');
              else if (error.code === 'auth/invalid-email') setAuthError('Email inv√°lido');
              else setAuthError(error.message);
            } finally {
              setIsAuthenticating(false);
            }
          };

          const handleLogin = async (e) => {
            e.preventDefault();
            setAuthError('');
            setIsAuthenticating(true);
            try {
              await window.signInWithEmailAndPassword(window.firebaseAuth, authData.email, authData.password);
              setShowAuthModal(false);
              setAuthData({ email: '', password: '', name: '', phone: '' });
            } catch (error) {
              if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                setAuthError('Email o contrase√±a incorrectos');
              } else {
                setAuthError('Error al iniciar sesi√≥n');
              }
            } finally {
              setIsAuthenticating(false);
            }
          };

          const handleGoogleLogin = async () => {
            setAuthError('');
            setIsAuthenticating(true);
            try {
              const result = await window.signInWithPopup(window.firebaseAuth, window.googleProvider);
              await window.firestoreAddDoc(window.firestoreCollection(window.firebaseDB, 'users'), {
                uid: result.user.uid,
                name: result.user.displayName || 'Cliente',
                email: result.user.email,
                phone: '',
                createdAt: window.firestoreServerTimestamp()
              });
              setShowAuthModal(false);
            } catch (error) {
              if (error.code === 'auth/popup-closed-by-user') setAuthError('Inicio de sesi√≥n cancelado');
              else setAuthError('Error al iniciar sesi√≥n con Google');
            } finally {
              setIsAuthenticating(false);
            }
          };

          const handleLogout = async () => {
            if (confirm('¬øCerrar sesi√≥n?')) {
              try {
                await window.signOut(window.firebaseAuth);
                setCart([]);
              } catch (error) {
                console.error('Error:', error);
              }
            }
          };

          const addToCart = (item) => {
            const existingItem = cart.find(i => i.id === item.id);
            if (existingItem) {
              setCart(cart.map(i => i.id === item.id ? { ...i, quantity: i.quantity + 1 } : i));
            } else {
              setCart([...cart, { ...item, quantity: 1 }]);
            }
          };

          const removeFromCart = (itemId) => {
            const existingItem = cart.find(i => i.id === itemId);
            if (existingItem.quantity === 1) {
              setCart(cart.filter(i => i.id !== itemId));
            } else {
              setCart(cart.map(i => i.id === itemId ? { ...i, quantity: i.quantity - 1 } : i));
            }
          };

          const deleteFromCart = (itemId) => { setCart(cart.filter(i => i.id !== itemId)); };

          const getTotal = () => { return cart.reduce((sum, item) => sum + (item.price * item.quantity), 0); };

          const openOrderModal = () => {
            if (cart.length === 0) {
              alert('Tu carrito est√° vac√≠o');
              return;
            }
            setShowOrderModal(true);
          };

          const submitOrder = async (e) => {
            e.preventDefault();
            setIsSubmitting(true);
            try {
              const order = {
                userId: user.uid,
                customerName: user.name,
                customerEmail: user.email,
                customerPhone: user.phone,
                items: cart,
                total: getTotal(),
                notes: orderNotes,
                status: 'pending',
                createdAt: window.firestoreServerTimestamp()
              };
              await window.firestoreAddDoc(window.firestoreCollection(window.firebaseDB, 'orders'), order);
              setCart([]);
              setOrderNotes('');
              setShowOrderModal(false);
              setShowCart(false);
              alert('‚úÖ ¬°Pedido realizado con √©xito!');
            } catch (error) {
              console.error('Error:', error);
              alert('‚ùå Error al enviar el pedido');
            } finally {
              setIsSubmitting(false);
            }
          };

          const filteredItems = selectedCategory === 'all' ? menuItems : menuItems.filter(item => item.category === selectedCategory);

          if (loading) {
            return (
              <div className="min-h-screen bg-gradient-to-br from-amber-50 to-orange-50 flex items-center justify-center">
                <div className="text-center">
                  <div className="text-6xl mb-4 animate-bounce">‚òï</div>
                  <p className="text-xl text-gray-600">Cargando...</p>
                </div>
              </div>
            );
          }

          return (
            <div className="min-h-screen bg-gradient-to-br from-amber-50 to-orange-50">
              <header className="bg-gradient-to-r from-amber-800 to-orange-700 text-white shadow-lg sticky top-0 z-40">
                <div className="container mx-auto px-4 py-4">
                  <div className="flex justify-between items-center">
                    <div>
                      <h1 className="text-2xl md:text-3xl font-bold flex items-center gap-2">‚òï Caf√© La Caba√±a</h1>
                      <p className="text-amber-100 text-sm mt-1">Sabor que inspira tu d√≠a</p>
                      {user && <p className="text-amber-200 text-xs mt-1">üë§ Hola, {user.name}!</p>}
                    </div>
                    <div className="flex gap-2 items-center">
                      <button onClick={() => setShowCart(!showCart)} className="relative bg-white text-amber-800 px-3 md:px-4 py-2 rounded-full font-semibold hover:bg-amber-100 transition flex items-center gap-2">
                        üõí <span className="hidden md:inline">{cart.length}</span>
                        {cart.length > 0 && (
                          <span className="absolute -top-2 -right-2 bg-red-500 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs">
                            {cart.reduce((sum, item) => sum + item.quantity, 0)}
                          </span>
                        )}
                      </button>
                      <button onClick={handleLogout} className="bg-red-500 text-white px-2 md:px-3 py-2 rounded-lg text-sm hover:bg-red-600 transition">üö™</button>
                    </div>
                  </div>
                </div>
              </header>

              <div className="bg-white shadow-md sticky top-16 md:top-20 z-30">
                <div className="container mx-auto px-4 py-4">
                  <div className="flex gap-2 overflow-x-auto">
                    {categories.map(cat => (
                      <button key={cat.id} onClick={() => setSelectedCategory(cat.id)}
                        className={`px-4 py-2 rounded-full font-medium whitespace-nowrap transition ${
                          selectedCategory === cat.id ? 'bg-amber-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                        }`}>
                        {cat.name}
                      </button>
                    ))}
                  </div>
                </div>
              </div>

              <div className="container mx-auto px-4 py-8">
                {loadingProducts ? (
                  <div className="text-center py-12">
                    <div className="text-6xl mb-4 animate-bounce">‚è≥</div>
                    <p className="text-xl text-gray-600">Cargando productos...</p>
                  </div>
                ) : menuItems.length === 0 ? (
                  <div className="text-center py-12 bg-white rounded-lg shadow">
                    <div className="text-6xl mb-4">üì¶</div>
                    <p className="text-xl text-gray-600 mb-4">No hay productos disponibles</p>
                    <p className="text-gray-500">Los productos aparecer√°n cuando se agreguen desde el admin</p>
                  </div>
                ) : filteredItems.length === 0 ? (
                  <div className="text-center py-12 bg-white rounded-lg shadow">
                    <div className="text-6xl mb-4">üîç</div>
                    <p className="text-xl text-gray-600">No hay productos en esta categor√≠a</p>
                  </div>
                ) : (
                  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    {filteredItems.map(item => (
                      <div key={item.id} className="bg-white rounded-xl shadow-md overflow-hidden hover:shadow-xl transition transform hover:-translate-y-1">
                        <div className="h-48 overflow-hidden">
                          <img src={item.image} alt={item.name} className="w-full h-full object-cover"/>
                        </div>
                        <div className="p-5">
                          <h3 className="text-xl font-bold text-gray-800 mb-2">{item.name}</h3>
                          <p className="text-gray-600 text-sm mb-4">{item.description}</p>
                          <div className="flex justify-between items-center">
                            <span className="text-2xl font-bold text-amber-700">${item.price}</span>
                            <button onClick={() => addToCart(item)} className="bg-amber-600 text-white px-4 py-2 rounded-lg hover:bg-amber-700 transition">‚ûï Agregar</button>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </div>

              {showAuthModal && (
                <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                  <div className="bg-white rounded-lg max-w-md w-full">
                    <div className="p-6">
                      <div className="text-center mb-6">
                        <div className="text-6xl mb-4">‚òï</div>
                        <h2 className="text-2xl font-bold text-gray-800 mb-2">{authMode === 'login' ? 'Iniciar Sesi√≥n' : 'Crear Cuenta'}</h2>
                        <p className="text-gray-600 text-sm">{authMode === 'login' ? 'Ingresa tus datos' : 'Reg√≠strate para hacer tu pedido'}</p>
                      </div>
                      {authError && <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-4 text-sm">{authError}</div>}
                      <form onSubmit={authMode === 'login' ? handleLogin : handleRegister}>
                        {authMode === 'register' && (
                          <>
                            <div className="mb-4">
                              <label className="block text-sm font-semibold text-gray-700 mb-2">Nombre *</label>
                              <input type="text" required value={authData.name} onChange={(e) => setAuthData({...authData, name: e.target.value})}
                                className="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500" placeholder="Juan P√©rez" disabled={isAuthenticating}/>
                            </div>
                            <div className="mb-4">
                              <label className="block text-sm font-semibold text-gray-700 mb-2">Tel√©fono *</label>
                              <input type="tel" required value={authData.phone} onChange={(e) => setAuthData({...authData, phone: e.target.value})}
                                className="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500" placeholder="9931234567" disabled={isAuthenticating}/>
                            </div>
                          </>
                        )}
                        <div className="mb-4">
                          <label className="block text-sm font-semibold text-gray-700 mb-2">Email *</label>
                          <input type="email" required value={authData.email} onChange={(e) => setAuthData({...authData, email: e.target.value})}
                            className="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500" placeholder="tu@email.com" disabled={isAuthenticating}/>
                        </div>
                        <div className="mb-6">
                          <label className="block text-sm font-semibold text-gray-700 mb-2">Contrase√±a *</label>
                          <input type="password" required value={authData.password} onChange={(e) => setAuthData({...authData, password: e.target.value})}
                            className="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500" placeholder="M√≠nimo 6 caracteres" disabled={isAuthenticating} minLength="6"/>
                        </div>
                        <button type="submit" disabled={isAuthenticating}
                          className="w-full bg-amber-600 text-white py-3 rounded-lg font-bold hover:bg-amber-700 transition disabled:bg-gray-400 mb-3">
                          {isAuthenticating ? '‚è≥ Procesando...' : (authMode === 'login' ? 'üîê Iniciar Sesi√≥n' : '‚úÖ Crear Cuenta')}
                        </button>
                        <button type="button" onClick={handleGoogleLogin} disabled={isAuthenticating}
                          className="w-full bg-white border-2 border-gray-300 text-gray-700 py-3 rounded-lg font-bold hover:bg-gray-50 transition flex items-center justify-center gap-2">
                          <svg className="w-5 h-5" viewBox="0 0 24 24">
                            <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                            <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                            <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                          </svg>
                          Continuar con Google
                        </button>
                      </form>
                      <div className="text-center mt-4">
                        <button onClick={() => { setAuthMode(authMode === 'login' ? 'register' : 'login'); setAuthError(''); }} className="text-amber-600 hover:text-amber-700 font-semibold text-sm">
                          {authMode === 'login' ? '¬øNo tienes cuenta? Reg√≠strate' : '¬øYa tienes cuenta? Inicia sesi√≥n'}
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              )}

              {showCart && (
                <div className="fixed inset-0 bg-black bg-opacity-50 z-50" onClick={() => setShowCart(false)}>
                  <div className="fixed right-0 top-0 h-full w-full max-w-md bg-white shadow-2xl overflow-y-auto" onClick={(e) => e.stopPropagation()}>
                    <div className="p-6">
                      <div className="flex justify-between items-center mb-6">
                        <h2 className="text-2xl font-bold text-gray-800">Tu Pedido</h2>
                        <button onClick={() => setShowCart(false)} className="text-gray-500 hover:text-gray-700 text-2xl">‚úï</button>
                      </div>
                      {cart.length === 0 ? (
                        <div className="text-center py-12">
                          <div className="text-6xl mb-4">üõí</div>
                          <p className="text-gray-500">Tu carrito est√° vac√≠o</p>
                        </div>
                      ) : (
                        <>
                          <div className="space-y-4 mb-6">
                            {cart.map(item => (
                              <div key={item.id} className="flex gap-4 bg-gray-50 p-4 rounded-lg">
                                <img src={item.image} alt={item.name} className="w-20 h-20 object-cover rounded-lg"/>
                                <div className="flex-1">
                                  <h3 className="font-semibold text-gray-800">{item.name}</h3>
                                  <p className="text-amber-700 font-bold">${item.price}</p>
                                  <div className="flex items-center gap-3 mt-2">
                                    <button onClick={() => removeFromCart(item.id)} className="bg-gray-300 text-gray-700 w-7 h-7 rounded-full hover:bg-gray-400">‚ûñ</button>
                                    <span className="font-semibold">{item.quantity}</span>
                                    <button onClick={() => addToCart(item)} className="bg-amber-600 text-white w-7 h-7 rounded-full hover:bg-amber-700">‚ûï</button>
                                    <button onClick={() => deleteFromCart(item.id)} className="ml-auto text-red-500 hover:text-red-700">‚úï</button>
                                  </div>
                                </div>
                              </div>
                            ))}
                          </div>
                          <div className="border-t pt-4">
                            <div className="flex justify-between items-center mb-4">
                              <span className="text-xl font-bold text-gray-800">Total:</span>
                              <span className="text-3xl font-bold text-amber-700">${getTotal()}</span>
                            </div>
                            <button onClick={openOrderModal} className="w-full bg-gradient-to-r from-amber-600 to-orange-600 text-white py-4 rounded-lg font-bold text-lg hover:from-amber-700 hover:to-orange-700 transition">
                              üì± Realizar Pedido
                            </button>
                          </div>
                        </>
                      )}
                    </div>
                  </div>
                </div>
              )}

              {showOrderModal && (
                <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                  <div className="bg-white rounded-lg max-w-md w-full">
                    <div className="p-6">
                      <h2 className="text-2xl font-bold text-gray-800 mb-4">Confirmar Pedido</h2>
                      <form onSubmit={submitOrder}>
                        <div className="bg-amber-50 p-4 rounded-lg mb-4">
                          <div className="text-sm text-gray-600 mb-2"><strong>Cliente:</strong> {user.name}</div>
                          {user.phone && <div className="text-sm text-gray-600 mb-2"><strong>Tel√©fono:</strong> {user.phone}</div>}
                          <div className="text-sm text-gray-600"><strong>Email:</strong> {user.email}</div>
                        </div>
                        <div className="mb-4">
                          <label className="block text-sm font-semibold text-gray-700 mb-2">Notas especiales (opcional)</label>
                          <textarea value={orderNotes} onChange={(e) => setOrderNotes(e.target.value)}
                            className="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500" rows="3"
                            placeholder="Sin az√∫car, extra caliente, etc." disabled={isSubmitting}/>
                        </div>
                        <div className="bg-amber-50 p-4 rounded-lg mb-4">
                          <div className="flex justify-between items-center">
                            <span className="font-semibold text-gray-700">Total:</span>
                            <span className="text-2xl font-bold text-amber-700">${getTotal()}</span>
                          </div>
                        </div>
                        <div className="flex gap-3">
                          <button type="submit" disabled={isSubmitting}
                            className="flex-1 bg-green-600 text-white py-3 rounded-lg font-bold hover:bg-green-700 transition disabled:bg-gray-400">
                            {isSubmitting ? '‚è≥ Enviando...' : '‚úÖ Confirmar'}
                          </button>
                          <button type="button" onClick={() => setShowOrderModal(false)} disabled={isSubmitting}
                            className="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg font-bold hover:bg-gray-400 transition">
                            Cancelar
                          </button>
                        </div>
                      </form>
                    </div>
                  </div>
                </div>
              )}
            </div>
          );
        };

        ReactDOM.render(<CafeLaCabana />, document.getElementById('root'));
    </script>
</body>
</html>
