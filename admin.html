<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Caf√© La Caba√±a</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div id="root"></div>
    
    <script>
      // CONFIGURACI√ìN DE SUPABASE
      const SUPABASE_URL = 'https://cxcxtrhxkptchqmitvbr.supabase.co';
      const SUPABASE_KEY = 'sb_publishable_QyiQjzIMUcj_x74gzUDjQw_aaODJR7R';
      const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

      console.log('‚úÖ Supabase Admin conectado');
    </script>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script type="text/babel">
        const AdminPanel = () => {
          const [products, setProducts] = React.useState([]);
          const [loading, setLoading] = React.useState(true);
          const [showModal, setShowModal] = React.useState(false);
          const [editingProduct, setEditingProduct] = React.useState(null);
          const [formData, setFormData] = React.useState({
            name: '',
            category: 'hot',
            price: '',
            description: '',
            image: ''
          });
          const [isSaving, setIsSaving] = React.useState(false);

          const categories = [
            { id: 'hot', name: 'Bebidas Calientes' },
            { id: 'cold', name: 'Bebidas Fr√≠as' },
            { id: 'dessert', name: 'Postres' },
            { id: 'snack', name: 'Snacks' }
          ];

          React.useEffect(() => {
            loadProducts();
            subscribeToProducts();
          }, []);

          const loadProducts = async () => {
            try {
              const { data, error } = await supabase
                .from('products')
                .select('*')
                .order('created_at', { ascending: false });

              if (error) throw error;

              console.log(`‚úÖ ${data.length} productos cargados`);
              setProducts(data);
              setLoading(false);
            } catch (error) {
              console.error('‚ùå Error:', error);
              alert('Error al cargar productos: ' + error.message);
              setLoading(false);
            }
          };

          const subscribeToProducts = () => {
            const subscription = supabase
              .channel('products_admin_changes')
              .on('postgres_changes',
                { event: '*', schema: 'public', table: 'products' },
                (payload) => {
                  console.log('üîÑ Cambio detectado:', payload);
                  loadProducts();
                }
              )
              .subscribe();

            return () => {
              subscription.unsubscribe();
            };
          };

          const openAddModal = () => {
            setEditingProduct(null);
            setFormData({ name: '', category: 'hot', price: '', description: '', image: '' });
            setShowModal(true);
          };

          const openEditModal = (product) => {
            setEditingProduct(product);
            setFormData({
              name: product.name,
              category: product.category,
              price: product.price,
              description: product.description,
              image: product.image
            });
            setShowModal(true);
          };

          const handleSubmit = async (e) => {
            e.preventDefault();
            setIsSaving(true);

            try {
              const productData = {
                name: formData.name,
                category: formData.category,
                price: parseFloat(formData.price),
                description: formData.description,
                image: formData.image
              };

              if (editingProduct) {
                productData.updated_at = new Date().toISOString();

                const { error } = await supabase
                  .from('products')
                  .update(productData)
                  .eq('id', editingProduct.id);

                if (error) throw error;

                alert('‚úÖ Producto actualizado');
              } else {
                const { error } = await supabase
                  .from('products')
                  .insert([productData]);

                if (error) throw error;

                alert('‚úÖ Producto agregado');
              }

              setShowModal(false);
              setFormData({ name: '', category: 'hot', price: '', description: '', image: '' });
              loadProducts();
            } catch (error) {
              console.error('‚ùå Error:', error);
              alert('‚ùå Error: ' + error.message);
            } finally {
              setIsSaving(false);
            }
          };

          const deleteProduct = async (id) => {
            if (confirm('¬øEliminar este producto?')) {
              try {
                const { error } = await supabase
                  .from('products')
                  .delete()
                  .eq('id', id);

                if (error) throw error;

                alert('‚úÖ Producto eliminado');
                loadProducts();
              } catch (error) {
                console.error('‚ùå Error:', error);
                alert('‚ùå Error: ' + error.message);
              }
            }
          };

          const getCategoryName = (categoryId) => {
            return categories.find(c => c.id === categoryId)?.name || categoryId;
          };

          if (loading) {
            return (
              <div className="min-h-screen bg-gray-100 flex items-center justify-center">
                <div className="text-center">
                  <div className="text-6xl mb-4 animate-bounce">‚òï</div>
                  <p className="text-xl text-gray-600">Cargando...</p>
                </div>
              </div>
            );
          }

          return (
            <div className="min-h-screen bg-gray-100">
              <header className="bg-gradient-to-r from-amber-800 to-orange-700 text-white shadow-lg">
                <div className="container mx-auto px-4 py-6">
                  <div className="flex justify-between items-center">
                    <div>
                      <h1 className="text-3xl font-bold">Panel de Administraci√≥n</h1>
                      <p className="text-amber-100 text-sm mt-1">Caf√© La Caba√±a</p>
                    </div>
                    <div className="flex gap-2">
                      <a href="index.html" className="bg-white text-amber-800 px-4 py-2 rounded-lg font-semibold hover:bg-amber-100 transition">Ver Men√∫</a>
                      <a href="pedidos.html" className="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 transition">Pedidos</a>
                    </div>
                  </div>
                </div>
              </header>

              <div className="container mx-auto px-4 py-8">
                <div className="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                  <div className="bg-white rounded-lg shadow p-6">
                    <div className="text-gray-500 text-sm mb-1">Total Productos</div>
                    <div className="text-3xl font-bold text-gray-800">{products.length}</div>
                  </div>
                  <div className="bg-white rounded-lg shadow p-6">
                    <div className="text-gray-500 text-sm mb-1">Bebidas Calientes</div>
                    <div className="text-3xl font-bold text-orange-600">{products.filter(p => p.category === 'hot').length}</div>
                  </div>
                  <div className="bg-white rounded-lg shadow p-6">
                    <div className="text-gray-500 text-sm mb-1">Bebidas Fr√≠as</div>
                    <div className="text-3xl font-bold text-blue-600">{products.filter(p => p.category === 'cold').length}</div>
                  </div>
                  <div className="bg-white rounded-lg shadow p-6">
                    <div className="text-gray-500 text-sm mb-1">Postres & Snacks</div>
                    <div className="text-3xl font-bold text-pink-600">{products.filter(p => p.category === 'dessert' || p.category === 'snack').length}</div>
                  </div>
                </div>

                <div className="mb-6">
                  <button onClick={openAddModal} className="bg-green-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-green-700 transition text-lg">
                    ‚ûï Agregar Nuevo Producto
                  </button>
                </div>

                {products.length === 0 ? (
                  <div className="bg-white rounded-lg shadow p-12 text-center">
                    <div className="text-6xl mb-4">üì¶</div>
                    <p className="text-gray-500 text-lg mb-4">No hay productos registrados</p>
                    <button onClick={openAddModal} className="bg-green-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-green-700 transition">
                      Agregar primer producto
                    </button>
                  </div>
                ) : (
                  <div className="bg-white rounded-lg shadow overflow-hidden">
                    <div className="overflow-x-auto">
                      <table className="w-full">
                        <thead className="bg-gray-50 border-b">
                          <tr>
                            <th className="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase">Imagen</th>
                            <th className="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase">Nombre</th>
                            <th className="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase">Categor√≠a</th>
                            <th className="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase">Precio</th>
                            <th className="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase">Descripci√≥n</th>
                            <th className="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase">Acciones</th>
                          </tr>
                        </thead>
                        <tbody className="divide-y divide-gray-200">
                          {products.map(product => (
                            <tr key={product.id} className="hover:bg-gray-50">
                              <td className="px-6 py-4">
                                <img src={product.image} alt={product.name} className="w-16 h-16 object-cover rounded-lg"/>
                              </td>
                              <td className="px-6 py-4 font-semibold text-gray-800">{product.name}</td>
                              <td className="px-6 py-4">
                                <span className="px-3 py-1 rounded-full text-xs font-semibold bg-amber-100 text-amber-800">
                                  {getCategoryName(product.category)}
                                </span>
                              </td>
                              <td className="px-6 py-4 font-bold text-green-600">${product.price}</td>
                              <td className="px-6 py-4 text-sm text-gray-600 max-w-xs truncate">{product.description}</td>
                              <td className="px-6 py-4">
                                <div className="flex gap-2">
                                  <button onClick={() => openEditModal(product)} className="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 transition text-sm">‚úèÔ∏è Editar</button>
                                  <button onClick={() => deleteProduct(product.id)} className="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 transition text-sm">üóëÔ∏è Eliminar</button>
                                </div>
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </div>
                )}
              </div>

              {showModal && (
                <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                  <div className="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                    <div className="p-6">
                      <div className="flex justify-between items-center mb-6">
                        <h2 className="text-2xl font-bold text-gray-800">{editingProduct ? 'Editar Producto' : 'Agregar Nuevo Producto'}</h2>
                        <button onClick={() => setShowModal(false)} disabled={isSaving} className="text-gray-500 hover:text-gray-700 text-2xl">‚úï</button>
                      </div>

                      <form onSubmit={handleSubmit}>
                        <div className="space-y-4">
                          <div>
                            <label className="block text-sm font-semibold text-gray-700 mb-2">Nombre del Producto *</label>
                            <input type="text" required value={formData.name} onChange={(e) => setFormData({...formData, name: e.target.value})} 
                              className="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500" placeholder="Ej: Caf√© Americano" disabled={isSaving}/>
                          </div>
                          <div>
                            <label className="block text-sm font-semibold text-gray-700 mb-2">Categor√≠a *</label>
                            <select required value={formData.category} onChange={(e) => setFormData({...formData, category: e.target.value})} 
                              className="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500" disabled={isSaving}>
                              {categories.map(cat => (<option key={cat.id} value={cat.id}>{cat.name}</option>))}
                            </select>
                          </div>
                          <div>
                            <label className="block text-sm font-semibold text-gray-700 mb-2">Precio ($) *</label>
                            <input type="number" required min="0" step="0.01" value={formData.price} onChange={(e) => setFormData({...formData, price: e.target.value})} 
                              className="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500" placeholder="Ej: 45" disabled={isSaving}/>
                          </div>
                          <div>
                            <label className="block text-sm font-semibold text-gray-700 mb-2">Descripci√≥n *</label>
                            <textarea required value={formData.description} onChange={(e) => setFormData({...formData, description: e.target.value})} 
                              className="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500" rows="3" 
                              placeholder="Ej: Espresso suave con agua caliente" disabled={isSaving}/>
                          </div>
                          <div>
                            <label className="block text-sm font-semibold text-gray-700 mb-2">URL de la Imagen *</label>
                            <input type="url" required value={formData.image} onChange={(e) => setFormData({...formData, image: e.target.value})} 
                              className="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500" 
                              placeholder="https://ejemplo.com/imagen.jpg" disabled={isSaving}/>
                            {formData.image && (<img src={formData.image} alt="Preview" className="mt-3 w-32 h-32 object-cover rounded-lg" onError={(e) => e.target.style.display = 'none'}/>)}
                          </div>
                        </div>
                        <div className="flex gap-4 mt-6">
                          <button type="submit" disabled={isSaving} className="flex-1 bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition disabled:bg-gray-400 disabled:cursor-not-allowed">
                            {isSaving ? '‚è≥ Guardando...' : (editingProduct ? 'üíæ Guardar Cambios' : '‚ûï Agregar Producto')}
                          </button>
                          <button type="button" onClick={() => setShowModal(false)} disabled={isSaving} className="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-400 transition disabled:opacity-50">Cancelar</button>
                        </div>
                      </form>
                    </div>
                  </div>
                </div>
              )}
            </div>
          );
        };

        ReactDOM.render(<AdminPanel />, document.getElementById('root'));
    </script>
</body>
</html>
